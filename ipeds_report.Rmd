---
title: "Modeling Postsecondary Retention Rates in the United States"
author: "Emily Mo"
date: "12/2/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(car)
library(arm)
library(MCMCglmm)
```

# Why Model Retention Rates?

Retention rates are one of the most commonly used measures of an educational institution’s success in educating its students and preparing them for successful careers, and a high retention rate is a badge of honor that institutions tend to strive for. However, an institution’s retention rate is a product of not only the institution’s accessibility to students, but also external factors that impact students—thus, retention rate as a standalone metric may not be very informative about an institution’s educational efficacy. I used data from the Integrated Postsecondary Education System Data System (IPEDS) in order to construct multilevel Binomial models of retention rates based on several institutional characteristics and offerings. Because these models only consider predictors on the institutional level and includes no predictors about institutions’ student bodies, they are not intended to—and in fact are not able to—paint a complete picture of the factors that impact retention rates. Instead, the models serve to pinpoint how several helpful educational features within institutions may relate to retention rates across the US, but also to demonstrate that it can be misleading to portray institutional success metrics as a direct product of an institution's efforts, due to the inevitable extra-curricular influences that can be confounded with such educational features. 

The data used in these models consisted of institutions in IPEDS records that had retention rate and public/private status information (public, private for-profit, private not-for-profit) available from 2017. All variables used were collected in 2017, which was the most recent year for which all variables of interest were available on the IPEDS data portal. I chose to use distance learning options, recreational options, and life experience credit as predictors because they are offerings that are presumably implemented with the purpose of making college a more welcoming place: distance learning makes educational attainment more accessible to those who may be working or may have difficulty physically attending a class, credit for life experiences acknowledges that accreditable learning opportunities do not all occur within the classroom, and recreational options allow students to take a break from traditional academics while still learning new skills. ^[IPEDS defines “credit for life experiences” as “Credit earned by students for what they have learned through independent study, noncredit adult courses, work experience, portfolio demonstration, previous licensure or certification, or completion of other learning opportunities (military, government, or professional).] Additionally, a lower student-faculty ratio may make it easier for students to get individualized attention from faculty, which can make the educational experience feel more personalized. 

``` {r include = FALSE}
edu <- read.csv('Data_11-11-2019---187.csv')

colnames(edu) <- c(  
  'id', 'name', 
  'ret_part17', 'ret_full17', 'sfratio17',
  'ret_part16', 'ret_full16', 'sfratio16', 
  'ret_part15', 'ret_full15', 'sfratio15',  # 11
  'ret_part14', 'ret_full14', 'sfratio14',
  'acad_offer18', 'recr_offer18', 'lifeex18', 'dualcred18', 'tuitvary18', 'dist18',  # 20
  
  'acad_offer17', 'recr_offer17', 'tuitvary17', 'lifeex17', 'dualcred17', 'dist17',  # 26
  'acad_offer16', 'recr_offer16', 'tuitvary16', 'lifeex16', 'dualcred16',  # 31
  'acad_offer15', 'recr_offer15', 'tuitvary15', 'lifeex15', 'dualcred15',  # 36
  'acad_offer14', 'recr_offer14', 'lifeex14', 'dualcred14',  # 40
  'acad_offer13', 'recr_offer13', 'lifeex13', 'dualcred13',  # 44
  'ret_part13', 'ret_full13', 'sfratio13',  # 47
  'acad_offer12', 'recr_offer12', 'lifeex12', 'dualcred12',  # 51
  'ret_part12', 'ret_full12', 'sfratio12',  # 54
  'acad_offer11', 'recr_offer11', 'lifeex11', 'dualcred11',  # 58
  'ret_part11', 'ret_full11', 'sfratio11',  # 61
  'acad_offer10', 'recr_offer10', 'lifeex10', 'dualcred10',  # 65
  'ret_part10', 'ret_full10', 'sfratio10',  # 68
  'acad_offer09', 'recr_offer09', 'lifeex09', 'dualcred09',  # 72
  'state', 'highest_lvl',
  'gradrate_bach17', 'gradrate_bach16', 'gradrate_bach15',  # 77
  'nonres17', 'nonres16', 'nonres15', 'nonres14', 'nonres13', 'nonres12', 'nonres11', 'nonres10',  # 85
  'total17', 'total16', 'total15', 'total14', 'total13', 'total12', 'total11', 'total10', 'total09',  # 94
  'tuit_priv_fp17', 'tuit_priv_nfp17', 'tuit_pub17',  # 97
  'total_ft17',  # 98
  'X'  # 99
)

#### data cleaning / EDA ####
# make variable for public/private
edu$pubpriv <- apply(edu, MARGIN = 1, FUN = function (x) {
  if (!is.na(x['tuit_priv_fp17'])) {
    return('priv_fp')
  }
  else if (!is.na(x['tuit_priv_nfp17'])) {
    return('priv_nfp')
  }
  else if (!is.na(x['tuit_pub17'])) {
    return('pub')
  }
  else return(NA)
})

# make variable for tuition
for (i in 1:nrow(edu)) {
  if (!is.na(edu$tuit_priv_fp17[i])) {
    edu$tuit17[i] <- edu$tuit_priv_fp17[i]
  } 
  else if (!is.na(edu$tuit_priv_nfp17[i])) {
    edu$tuit17[i] <- edu$tuit_priv_nfp17[i]
  } 
  else if (!is.na(edu$tuit_pub17[i])) {
    edu$tuit17[i] <- edu$tuit_pub17[i]
  }
  else edu$tuit17[i] <- NA
}

edu17 <- dplyr::select(edu, id, name, state, pubpriv, highest_lvl, lifeex17, ret_full17, sfratio17, tuitvary17, acad_offer17, recr_offer17, dist17, gradrate_bach17, nonres17, total17, total_ft17, tuit17)

eduna <- is.na(edu17) %>% as.data.frame  # df for missing vars

# exclude those without pub/priv info (5386)
edu_17 <- edu17[!is.na(edu17$tuit17),] 
edu_17 <- edu_17[!is.na(edu_17$dist17) & !is.na(edu_17$lifeex17) & !is.na(edu_17$recr_offer17) & 
                   !is.na(edu_17$sfratio17) & !is.na(edu_17$pubpriv),]  # ones that are not missing the vars in question (5385)
```

``` {r include = FALSE}
# which(edu_17$state == '')
```

``` {r include = FALSE}
{
  edu_17$state[55] <- 'CA'
  edu_17$state[56] <- 'FL'
  edu_17$state[63] <- 'MD'
  edu_17$state[68] <- 'MA'
  edu_17$state[154] <- 'OK'  # American Broadcasting School-Oklahoma City 
  edu_17$state[155] <- 'OK'
  edu_17$state[209] <- 'PA'
  edu_17$state[433] <- 'MA'  # BCI - this is in malden 
  edu_17$state[440] <- NA  # found it online by searching ipeds id but it's under a different name so not sure
  edu_17$state[1031] <- 'OH'
  edu_17$state[1074] <- 'CA'  # Coleman University
  edu_17$state[1210] <- 'PA'
  edu_17$state[1244] <- 'VA'
  edu_17$state[1650] <- 'FL'
  edu_17$state[1876] <- 'GA'
  edu_17$state[1890] <- 'OH'  # Georgie International Beauty Institute  
  edu_17$state[1900] <- 'CO'
  edu_17$state[1901] <- NA  # Global Institute - too vague
  edu_17$state[1928] <- 'NE'
  edu_17$state[1979] <- 'MO'
  edu_17$state[1982] <- 'AZ'
  edu_17$state[1984] <- 'CA'
  edu_17$state[2206] <- 'PR'  # Instituto de Educacion Tecnica Ocupacional La Reine-Manati
  edu_17$state[2551] <- 'MA'
  edu_17$state[2555] <- 'MA'
  edu_17$state[2629] <- 'TX'  # Lubbock Hair Academy   
  edu_17$state[2746] <- 'HI'
  edu_17$state[2747] <- 'FL'
  edu_17$state[2748] <- 'FL'
  edu_17$state[2984] <- 'IL'  # Morthland College 
  edu_17$state[2993] <- 'MA'
  edu_17$state[3266] <- 'TN'
  edu_17$state[3342] <- 'NE'
  edu_17$state[3351] <- 'PA'
  edu_17$state[3365] <- 'FL'  # Orion College 
  edu_17$state[3673] <- 'WA'
  edu_17$state[3741] <- 'CA'
  edu_17$state[3785] <- 'CT'
  edu_17$state[3786] <- 'NY'
  edu_17$state[3839] <- 'OR'  # Roseburg Beauty College 
  edu_17$state[4233] <- 'MO'
  edu_17$state[4255] <- 'NJ'
  edu_17$state[4328] <- 'WA'
  edu_17$state[4581] <- 'CA'  # Thuy Princess Beauty College 
  edu_17$state[5218] <- 'TN'
  edu_17$state[5330] <- 'PA'
  edu_17$state[5331] <- 'FL'
  edu_17$state[5368] <- 'NY'
}

edu_17 <- edu_17[!is.na(edu_17$state),]  # 5383
```

``` {r include = FALSE}
# print(nrow(edu_17))
```

``` {r include = FALSE}
#### making new vars ####
# centered sfratio, for easier interpretation
edu_17$sfratio_c <- edu_17$sfratio17 - mean(edu_17$sfratio17)  # ftr, mean is 15.268

# integer retention counts
edu_17$retcount <- round(edu_17$ret_full17 * edu_17$total_ft17 / 100)  # make column for number of retained
edu_17$notret <- edu_17$total_ft17 - edu_17$retcount  # and for number of not retained
```

# Models

Using this cleaned and narrowed data set, I fit two Binomial regression models with increasingly complex hierarchical structure. Because a Laplacian fitting algorithm produced nearly unidentifiable parameter estimates ^[Results from the Laplacian approach are detailed in Appendix A.)], I used a Bayesian fitting approach, which allowed for more nuanced evaluation of the parameters’ convergence, as well as permitted probabilistic statements about the parameters’ true values given the data.

## Model A: Multilevel model with varying intercepts per state and public/private status

Using a Markov Chain Monte Carlo algorithm, I fit a multilevel binomial model with varying intercepts for state and for public/private status. A multilevel structure was appropriate because it would account for the expected correlation of retention rates between colleges within the same state or within the same public/private status. A binomial regression was appropriate because each institution’s retention rate reflects a group of individuals, each of whom were retained or not retained—thus, each institution’s retention rate can be viewed as a binomial random variable. The institutional characteristics previously mentioned were used as the model’s non-varying predictors. The prior for this model was only specified with respect to the residual variance and the covariance structure of the varying intercepts. For all of those parameters, I supplied a weakly informative Inverse Chi-Square prior with a scale parameter of 1 and 2 degrees of freedom, which can be expressed as an Inverse Gamma distribution with a shape parameter of 1 and a scale parameter of 1. ^[Gelman, A. (2006). Prior distributions for variance parameters in hierarchical models (comment on article by Browne and Draper). Bayesian Analysis, 1(3), 515–534. doi: 10.1214/06-ba117a] The model was fit with 40,000 iterations, with a burn-in period of 6,000 and a thinning factor of 30. These parameters yielded a roughly stationary trace plot and a roughly symmetric distribution plot for each of the fixed coefficients in the model, which suggested that the parameter estimates were trustworthy. The coefficient estimates and between-group variance estimates are as follows ^[full model outputs can be found in Appendix B]:

``` {r}
set.seed(60)
prior_inf <- list(
  R = list(V = 1, nu = 2),
  G = list(G1 = list(V = 1, nu = 2),
           G2 = list(V = 1, nu = 2)))
ipeds_mcmc2 <- MCMCglmm(cbind(retcount, notret) ~ dist17 + lifeex17 + recr_offer17 + sfratio_c,
                        ~ us(1):state +
                          us(1):pubpriv,
                        data = edu_17, family = 'multinomial2',
                        prior = prior_inf,
                        nitt = 40000, thin = 30, burnin = 10000, pr = T, verbose = F)
summary(ipeds_mcmc2)
```

According to the model:  

* A baseline institution that has no distance learning options, offers no credit for life experiences, offers no recreational or avocational opportunities, and has a typical student-faculty ratio of about 15 is expected to have a log odds retention rate ratio ^[The log odds retention rate ratio is the natural logarithm of the ratio between retention rate and its complement.] of `r summary(ipeds_mcmc2$Sol)$statistics[1, 1] %>% round(3)`, meaning that the estimated retention rate of such an institution would be 
$logit^{-1}$ (`r {summary(ipeds_mcmc2$Sol)$statistics[1, 1] %>% round(3)}`) = `r (invlogit(summary(ipeds_mcmc2$Sol)$statistics[1, 1])) %>% round(3)`.
* An institution that offers distance learning options is expected to have a log odds retention rate ratio that is `r summary(ipeds_mcmc2$Sol)$statistics[2, 1] %>% round(3) %>% abs` less than that of an institution that does not offer distance learning options, given that credit for life experiences, recreational offerings, and student faculty ratio are held constant. While the corresponding change in retention rate itself can vary depending on the original retention rate, an estimated upper bound on the corresponding change in retention rate is `r summary(ipeds_mcmc2$Sol)$statistics[2, 1] %>% round(3)` / 4 = `r ((summary(ipeds_mcmc2$Sol)$statistics[2, 1] %>% round(3)) / 4) %>% round(3)`.
* An institution that offers credit for life experiences is expected to have a log odds retention rate ratio that is `r summary(ipeds_mcmc2$Sol)$statistics[3, 1] %>% round(3) %>% abs` less than that of an institution that does not offer credit for life experiences, given that distance learning offerings, recreational offerings, and student faculty ratio are held constant. While the corresponding change in retention rate itself can vary depending on the original retention rate, an estimated upper bound on the corresponding change in retention rate is `r summary(ipeds_mcmc2$Sol)$statistics[3, 1] %>% round(3)` / 4 = `r ((summary(ipeds_mcmc2$Sol)$statistics[3, 1] %>% round(3)) / 4) %>% round(3)`.
* An institution that offers recreational or avocational opportunities is expected to have a log odds retention rate ratio that is `r summary(ipeds_mcmc2$Sol)$statistics[4, 1] %>% round(3) %>% abs` less than that of an institution that does not offer recreational or avocational opportunities, given that distance learning offerings, credit for life experiences, and student faculty ratio are held constant. While the corresponding change in retention rate itself can vary depending on the original retention rate, an estimated upper bound on the corresponding change in retention rate is `r summary(ipeds_mcmc2$Sol)$statistics[4, 1] %>% round(3)` / 4 = `r ((summary(ipeds_mcmc2$Sol)$statistics[4, 1] %>% round(3)) / 4) %>% round(3)`.
* A unit increase in student-faculty ratio is generally associated with a decrease of `r summary(ipeds_mcmc2$Sol)$statistics[5, 1] %>% round(3) %>% abs` in the log odds ratio of retention rate, given that distance learning offerings, credit for life experiences, and recreational offerings are held constant. While the corresponding change in retention rate itself can vary depending on the original retention rate, an estimated upper bound on the corresponding change in retention rate is `r summary(ipeds_mcmc2$Sol)$statistics[5, 1] %>% round(3)` / 4 = `r ((summary(ipeds_mcmc2$Sol)$statistics[5, 1] %>% round(3)) / 4) %>% round(3)`.

The estimate for the variance between states’ baseline retention rates, `r summary(ipeds_mcmc2)$Gcovariances[1,1] %>% round(3)`, was small compared to the estimate for the variance between public/private statuses’ baseline retention rates, `r summary(ipeds_mcmc2)$Gcovariances[2,1] %>% round(3)`. This discrepancy suggested that the state grouping may not provide much additional information about the baseline retention rate after the overall baseline retention rate is already considered. However, there seems to be much more variation in retention rates between public, private not-for-profit, and private for-profit institutions.  

The estimated varying intercepts for public, private not-for-profit, and private for-profit were as follows:

``` {r echo = FALSE}
summary(ipeds_mcmc2$Sol)$statistics[64:66,1]
```

According to the model, a baseline institution that has no distance learning options, offers no credit for life experiences, offers no recreational or avocational opportunities, and has a typical student-faculty ratio is expected to have a retention rate of:  

* $logit^{-1}$ (`r {summary(ipeds_mcmc2$Sol)$statistics[1, 1] %>% round(3)}` - `r summary(ipeds_mcmc2$Sol)$statistics[64,1] %>% abs %>% round(3)`) = `r invlogit(summary(ipeds_mcmc2$Sol)$statistics[1, 1] + summary(ipeds_mcmc2$Sol)$statistics[64,1] ) %>% round(3)` if it is private for-profit
* $logit^{-1}$ (`r {summary(ipeds_mcmc2$Sol)$statistics[1, 1] %>% round(3)}` + `r summary(ipeds_mcmc2$Sol)$statistics[65,1] %>% abs %>% round(3)`) = `r invlogit(summary(ipeds_mcmc2$Sol)$statistics[1, 1] + summary(ipeds_mcmc2$Sol)$statistics[65,1] ) %>% round(3)` if it is private not-for-profit
* $logit^{-1}$ (`r {summary(ipeds_mcmc2$Sol)$statistics[1, 1] %>% round(3)}` - `r summary(ipeds_mcmc2$Sol)$statistics[66,1] %>% abs %>% round(3)`) = `r invlogit(summary(ipeds_mcmc2$Sol)$statistics[1, 1] + summary(ipeds_mcmc2$Sol)$statistics[66,1] ) %>% round(3)` if it is public

The variation in estimated baseline retention rate between the different public/private statuses remind us that the type of institution alone may be associated with factors that influence a student’s likelihood to stay in school, regardless of efforts made by the institution to prevent attrition. However, we must note that the standard deviation of these estimates all suggest 95% credible intervals that contain 0, so there is a great degree of uncertainty of these varying intercepts. 

## Model B: Multilevel model with varying intercepts per state and public/private status, and varying slope for recreational experiences per public/private status




